<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –¥–æ—Å–∫–∞ –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏ –ü—Ä–∞–π—Å</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <header id="main-header">
        <h1>üè≠ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏ –ü—Ä–∞–π—Å</h1>
        <div class="alert-banner" id="alert-banner" style="display: none;"></div>
        <div class="connection-status" id="connection-status">
            <div class="status-indicator status-offline" id="status-indicator"></div>
            <span id="status-text">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
        </div>
    </header>

    <div class="users-list" id="users-list">
        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
    </div>

    <div class="controls">
        <button id="connect-btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <!--        <button id="save-board">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>-->
        <!--        <button id="reset-board">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>-->
        <!--        <button id="reset-server-board" class="delete-btn">üóëÔ∏è –°–±—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–∞</button>-->

        <div class="zoom-controls">
            <button class="zoom-btn" id="zoom-out">-</button>
            <span class="zoom-level" id="zoom-level">100%</span>
            <button class="zoom-btn" id="zoom-in">+</button>
            <button class="zoom-btn" id="zoom-reset">‚ü≥</button>
        </div>
    </div>

    <div class="board-container">
        <div class="board" id="board">
            <!-- –ö–æ–ª–æ–Ω–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –∑–¥–µ—Å—å —á–µ—Ä–µ–∑ JS -->
        </div>
    </div>
</div>

<div class="save-notification" id="save-notification">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è —Å—Å—ã–ª–æ–∫ -->
<div class="overlay" id="link-overlay"></div>
<div class="link-notification" id="link-notification">
    <h3>–û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Å—ã–ª–∫–∏</h3>
    <p id="link-notification-text"></p>
    <div class="link-notification-buttons">
        <button id="link-open-btn">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button id="link-copy-btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        <button id="link-cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    // –î–∞–Ω–Ω—ã–µ –¥–æ—Å–∫–∏
    let boardData = {
        columns: [
            { id: 1, title: "–ó–∞–∫–∞–∑—ã", cards: [], collapsed: false },
            { id: 2, title: "–ü–µ—á–∞—Ç—å KBA", cards: [], collapsed: false },
            { id: 3, title: "–ü–µ—á–∞—Ç—å Roland", cards: [], collapsed: false },
            { id: 4, title: "–¢–∏—Å–Ω–µ–Ω–∏–µ", cards: [], collapsed: false },
            { id: 5, title: "–£–§", cards: [], collapsed: false },
            { id: 6, title: "–õ–∞–º–∏–Ω–∞—Ü–∏—è", cards: [], collapsed: false },
            { id: 7, title: "–ö–∞—à–∏—Ä–æ–≤–∫–∞", cards: [], collapsed: false },
            { id: 8, title: "–†–µ–∑–∫–∞", cards: [], collapsed: false },
            { id: 9, title: "–ö–æ–Ω–≥—Ä–µ–≤", cards: [], collapsed: false },
            { id: 10, title: "–í—ã—Å–µ—á–∫–∞", cards: [], collapsed: false },
            { id: 11, title: "–í—ã—Ä—É–±–∫–∞ –ë–†–ê–£–ó", cards: [], collapsed: false },
            { id: 12, title: "–í—ã—Ä—É–±–∫–∞ –¶–ï–ù–¢–£–†–ò–û–ù", cards: [], collapsed: false },
            { id: 13, title: "–í—ã–±–æ—Ä–∫–∞", cards: [], collapsed: false },
            { id: 14, title: "–ü–ª–µ–Ω–∫–∞", cards: [], collapsed: false },
            { id: 15, title: "–û–∫–æ—à–∫–∏", cards: [], collapsed: false },
            { id: 16, title: "–°–∫–ª–µ–π–∫–∞", cards: [], collapsed: false },
            { id: 17, title: "–°–≤–µ—Ä–ª–æ–≤–∫–∞", cards: [], collapsed: false },
            { id: 18, title: "–ë—Ä–æ—à—é—Ä–æ–≤–∫–∞", cards: [], collapsed: false },
            { id: 19, title: "–ü–æ–¥—Ä–µ–∑–∫–∞", cards: [], collapsed: false },
            { id: 20, title: "–£–ø–∞–∫–æ–≤–∫–∞", cards: [], collapsed: false },
            { id: 21, title: "–°–∫–ª–∞–¥", cards: [], collapsed: false }
        ]
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const boardElement = document.getElementById('board');
    const saveButton = document.getElementById('save-board');
    const resetButton = document.getElementById('reset-board');
    const resetServerButton = document.getElementById('reset-server-board');
    const saveNotification = document.getElementById('save-notification');
    const connectButton = document.getElementById('connect-btn');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const usersList = document.getElementById('users-list');
    const connectionStatus = document.getElementById('connection-status');
    const zoomInButton = document.getElementById('zoom-in');
    const zoomOutButton = document.getElementById('zoom-out');
    const zoomResetButton = document.getElementById('zoom-reset');
    const zoomLevelDisplay = document.getElementById('zoom-level');
    const alertBanner = document.getElementById('alert-banner');
    const linkOverlay = document.getElementById('link-overlay');
    const linkNotification = document.getElementById('link-notification');
    const linkNotificationText = document.getElementById('link-notification-text');
    const linkOpenBtn = document.getElementById('link-open-btn');
    const linkCopyBtn = document.getElementById('link-copy-btn');
    const linkCancelBtn = document.getElementById('link-cancel-btn');
    const mainHeader = document.getElementById('main-header');

    // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    let socket = null;
    let isConnected = false;
    let currentUser = null;
    let users = {};
    let serverAddress = '';

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    let zoomLevel = parseFloat(localStorage.getItem('kanbanZoomLevel') || 1);
    const minZoom = 0.5;
    const maxZoom = 2;
    const zoomStep = 0.1;

    // –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏
    const availableTags = [
        { id: 'design', name: '–§–æ—Ä–º—ã' },
        { id: 'print', name: '–ë—É–º–∞–≥–∞' },
        { id: 'cut', name: '–ü–æ–¥—Ä–µ–∑–∫–∞' },
        { id: 'bind', name: '–ì–æ—Ñ—Ä–∞' },
        { id: 'done', name: '–ü–ª–µ–Ω–∫–∞' },
        { id: 'one', name: '1–ø—Ä–æ–≥–æ–Ω' },
        { id: 'two', name: '2–ø—Ä–æ–≥–æ–Ω' }
    ];

    // –í–∏–¥—ã –∏–∑–¥–µ–ª–∏–π
    const productTypes = [
        '–≠—Ç–∏–∫', '–ö–æ—Ä–ö–∞—Ä—Ç', '–ö–æ—Ä–ì–ö', '–ë—É–∫–ª–µ—Ç', '–í–∫–ª–∞–¥—ã—à', '–û–±–µ—á–∞–π–∫–∞', '–Ø—Ä–ª—ã–∫'
    ];

    // –í–∏–¥—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
    const materialTypes = [
        '–≠—Ç–∏–∫', '–≠—Ç–ú–µ—Ç', '–û—Ñ—Å–µ—Ç', '–ú–µ–ª–æ–≤–∫–∞', '–ö–∞—Ä—Ç', '–ö–∞—Ä—Ç–ú–µ—Ç', '–ö–∞—à–∏—Ä–ì–ö', '–ì–ö', '–ü–ª–µ–Ω–∫–∞'
    ];

    // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
    let draggedCard = null;
    let sourceColumnId = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å–∫–∏
    function initBoard() {
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const savedData = localStorage.getItem('typographyKanban');
        if (savedData) {
            try {
                const parsedData = JSON.parse(savedData);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–µ—Ä–Ω—É—Ç–æ—Å—Ç–∏ –∫–æ–ª–æ–Ω–æ–∫
                if (parsedData.columns) {
                    parsedData.columns.forEach(column => {
                        const existingColumn = boardData.columns.find(c => c.id === column.id);
                        if (existingColumn) {
                            existingColumn.collapsed = column.collapsed || false;
                            existingColumn.cards = column.cards || [];
                        }
                    });
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        applyZoom();

        renderBoard();

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–µ–¥–ª–∞–π–Ω–æ–≤ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(checkDeadlines, 5 * 60 * 1000);
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–¥–ª–∞–π–Ω–æ–≤
    function checkDeadlines() {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        let hasOverdue = false;
        let hasDueSoon = false;

        boardData.columns.forEach(column => {
            column.cards.forEach(card => {
                if (card.deadline) {
                    const deadlineDate = new Date(card.deadline);
                    const deadlineDay = new Date(deadlineDate.getFullYear(), deadlineDate.getMonth(), deadlineDate.getDate());

                    const diffTime = deadlineDay - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ –¥–µ–¥–ª–∞–π–Ω–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
                    card.deadlineStatus = diffDays < 0 ? 'overdue' :
                        diffDays === 0 ? 'due-today' :
                            diffDays <= 2 ? 'due-soon' : 'normal';

                    if (diffDays < 0) hasOverdue = true;
                    if (diffDays <= 2 && diffDays >= 0) hasDueSoon = true;
                }
            });
        });

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–æ—Å–∫—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
        renderBoard();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        // if (hasOverdue) {
        //     showNotification('–í–Ω–∏–º–∞–Ω–∏–µ! –ï—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã!');
        // }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    function applyZoom() {
        document.documentElement.style.setProperty('--zoom-level', zoomLevel);
        zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
        localStorage.setItem('kanbanZoomLevel', zoomLevel.toString());

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–æ—Å–∫—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞
        renderBoard();
    }

    function zoomIn() {
        if (zoomLevel < maxZoom) {
            zoomLevel = Math.min(maxZoom, zoomLevel + zoomStep);
            applyZoom();
        }
    }

    function zoomOut() {
        if (zoomLevel > minZoom) {
            zoomLevel = Math.max(minZoom, zoomLevel - zoomStep);
            applyZoom();
        }
    }

    function resetZoom() {
        zoomLevel = 1;
        applyZoom();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && !e.altKey) {
            if (e.key === '+' || e.key === '=') {
                e.preventDefault();
                zoomIn();
            } else if (e.key === '-' || e.key === '_') {
                e.preventDefault();
                zoomOut();
            } else if (e.key === '0') {
                e.preventDefault();
                resetZoom();
            }
        }
    });

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
    function connectToServer() {
        if (isConnected) {
            disconnectFromServer();
            return;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        let host = window.location.hostname;

        // –ï—Å–ª–∏ –º—ã –Ω–µ –Ω–∞ localhost, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —Ö–æ—Å—Ç
        if (host === 'localhost' || host === '127.0.0.1') {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º IP —Å–µ—Ä–≤–µ—Ä–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const defaultIP = window.location.hostname === 'localhost' ? '127.0.0.1' : window.location.hostname;
            host = prompt('–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞:', defaultIP);
            if (!host) return;
        }

        serverAddress = `${protocol}//${host}:3001`;

        // –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userName = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å${Math.floor(Math.random() * 1000)}`);
        if (!userName) return;

        try {
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
            socket = new WebSocket(serverAddress);

            socket.onopen = () => {
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                isConnected = true;
                currentUser = {
                    id: generateUserId(),
                    name: userName,
                    color: generateUserColor()
                };

                updateConnectionStatus(true);
                connectButton.textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è';

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                sendMessage({
                    type: 'user_joined',
                    user: currentUser
                });

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏
                sendMessage({
                    type: 'get_board'
                });
            };

            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleServerMessage(message);
            };

            socket.onclose = () => {
                console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                isConnected = false;
                updateConnectionStatus(false);
                connectButton.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
            };

            socket.onerror = (error) => {
                console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É ${serverAddress}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.`);
                isConnected = false;
                updateConnectionStatus(false);
                connectButton.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
            };

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
            alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É ${serverAddress}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.`);
        }
    }

    // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    function disconnectFromServer() {
        if (socket) {
            sendMessage({
                type: 'user_left',
                userId: currentUser.id
            });
            socket.close();
            socket = null;
        }
        isConnected = false;
        currentUser = null;
        users = {};
        updateUsersList();
        updateConnectionStatus(false);
        connectButton.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    function sendMessage(message) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(message));
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    function handleServerMessage(message) {
        switch (message.type) {
            case 'board_data':
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–µ—Ä–Ω—É—Ç–æ—Å—Ç–∏ –∫–æ–ª–æ–Ω–æ–∫
                if (message.data.columns) {
                    message.data.columns.forEach(column => {
                        const existingColumn = boardData.columns.find(c => c.id === column.id);
                        if (existingColumn) {
                            column.collapsed = existingColumn.collapsed || false;
                        }
                    });
                }
                boardData = message.data;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–¥–ª–∞–π–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                checkDeadlines();
                renderBoard();
                break;

            case 'card_moved':
                if (message.userId !== currentUser.id) {
                    applyCardMove(message.cardId, message.fromColumnId, message.toColumnId);
                }
                break;

            case 'card_created':
                if (message.userId !== currentUser.id) {
                    const column = boardData.columns.find(col => col.id === message.columnId);
                    if (column) {
                        column.cards.push(message.card);
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–¥–ª–∞–π–Ω –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                        checkDeadlines();
                        renderBoard();
                    }
                }
                break;

            case 'card_updated':
                if (message.userId !== currentUser.id) {
                    const column = boardData.columns.find(col => col.id === message.columnId);
                    if (column) {
                        const cardIndex = column.cards.findIndex(card => card.id === message.card.id);
                        if (cardIndex !== -1) {
                            column.cards[cardIndex] = message.card;
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–¥–ª–∞–π–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                            checkDeadlines();
                            renderBoard();
                        }
                    }
                }
                break;

            case 'card_deleted':
                if (message.userId !== currentUser.id) {
                    const column = boardData.columns.find(col => col.id === message.columnId);
                    if (column) {
                        column.cards = column.cards.filter(card => card.id !== message.cardId);
                        renderBoard();
                    }
                }
                break;

            case 'card_reordered':
                if (message.userId !== currentUser.id) {
                    const column = boardData.columns.find(col => col.id === message.columnId);
                    if (column) {
                        column.cards = message.cards;
                        renderBoard();
                    }
                }
                break;

            case 'users_list':
                users = message.users;
                updateUsersList();
                break;

            case 'user_joined':
                users[message.user.id] = message.user;
                updateUsersList();
                showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${message.user.name} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è`);
                break;

            case 'user_left':
                if (users[message.userId]) {
                    showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${users[message.userId].name} –æ—Ç–∫–ª—é—á–∏–ª—Å—è`);
                    delete users[message.userId];
                    updateUsersList();
                }
                break;

            case 'alert_created':
                showAlertBanner(message.alertText);
                break;

            case 'alert_cleared':
                hideAlertBanner();
                break;
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–Ω–Ω–µ—Ä –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
    function showAlertBanner(alertText) {
        alertBanner.textContent = alertText;
        alertBanner.style.display = 'block';
    }

    // –°–∫—Ä—ã—Ç—å –±–∞–Ω–Ω–µ—Ä –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
    function hideAlertBanner() {
        alertBanner.style.display = 'none';
    }

    // –°–æ–∑–¥–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ
    function createAlert(card, columnId) {
        const column = boardData.columns.find(col => col.id === columnId);
        const alertText = `üö® –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–∫–∞–∑–æ–º "${card.title}" (${card.orderId || '–±–µ–∑ –Ω–æ–º–µ—Ä–∞'}) –≤ –∫–æ–ª–æ–Ω–∫–µ "${column.title}"`;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        showAlertBanner(alertText);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        if (isConnected) {
            sendMessage({
                type: 'alert_created',
                userId: currentUser.id,
                alertText: alertText
            });
        }
    }

    // –û—á–∏—Å—Ç–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ
    function clearAlert() {
        hideAlertBanner();

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        if (isConnected) {
            sendMessage({
                type: 'alert_cleared',
                userId: currentUser.id
            });
        }
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
    function applyCardMove(cardId, fromColumnId, toColumnId) {
        // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –∏ –∏—Å—Ö–æ–¥–Ω—É—é –∫–æ–ª–æ–Ω–∫—É
        let sourceColumn = null;
        let card = null;

        for (const column of boardData.columns) {
            const cardIndex = column.cards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1) {
                sourceColumn = column;
                card = column.cards[cardIndex];
                break;
            }
        }

        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∫–∞—Ä–æ—á–∫—É –∏ –æ–Ω–∞ –Ω–µ –≤ —Ü–µ–ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ
        if (sourceColumn && card && sourceColumn.id !== toColumnId) {
            // –£–¥–∞–ª—è–µ–º –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏
            sourceColumn.cards = sourceColumn.cards.filter(c => c.id !== cardId);

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ü–µ–ª–µ–≤—É—é –∫–æ–ª–æ–Ω–∫—É
            const targetColumn = boardData.columns.find(col => col.id === toColumnId);
            if (targetColumn) {
                targetColumn.cards.push(card);
                renderBoard();
            }
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    function updateConnectionStatus(connected) {
        if (connected) {
            statusIndicator.className = 'status-indicator status-online';
            statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            connectionStatus.style.backgroundColor = '#e3fcef';
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            mainHeader.classList.add('connected');
        } else {
            statusIndicator.className = 'status-indicator status-offline';
            statusText.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
            connectionStatus.style.backgroundColor = '#ffebeb';
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            mainHeader.classList.remove('connected');
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function updateUsersList() {
        usersList.innerHTML = '';

        for (const userId in users) {
            const user = users[userId];
            const userBadge = document.createElement('div');
            userBadge.className = 'user-badge';
            userBadge.innerHTML = `
                    <div class="user-indicator status-online"></div>
                    <span>${user.name}</span>
                `;
            usersList.appendChild(userBadge);
        }
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(text) {
        saveNotification.textContent = text;
        saveNotification.classList.add('show');
        setTimeout(() => {
            saveNotification.classList.remove('show');
        }, 3000);
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function generateUserId() {
        return 'user_' + Math.random().toString(36).substr(2, 9);
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function generateUserColor() {
        const colors = [
            '#00b8d9', '#0052cc', '#5243aa', '#ff5630',
            '#ffab00', '#36b37e', '#00875a', '#253858'
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è PDF —Å—Å—ã–ª–∫–∏
    function openPdfLink(url, title) {
        const overlay = document.getElementById('link-overlay');
        const notification = document.getElementById('link-notification');
        const notificationText = document.getElementById('link-notification-text');
        const openBtn = document.getElementById('link-open-btn');
        const copyBtn = document.getElementById('link-copy-btn');
        const cancelBtn = document.getElementById('link-cancel-btn');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å—Å—ã–ª–∫–∏
        const isLocalFile = url.startsWith('file://') || url.startsWith('/') || /^[A-Za-z]:\\/.test(url);
        const isHttpLink = url.startsWith('http://') || url.startsWith('https://');

        let message = '';

        if (isLocalFile) {
            message = `–õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª: ${url}<br><br>
                      <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.`;
        } else if (isHttpLink) {
            message = `–í–µ–±-—Å—Å—ã–ª–∫–∞: ${url}<br><br>
                      –°—Å—ã–ª–∫–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ –±—Ä–∞—É–∑–µ—Ä–∞.`;
        } else {
            message = `–°—Å—ã–ª–∫–∞: ${url}<br><br>
                      –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏.`;
        }

        notificationText.innerHTML = message;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        overlay.classList.add('show');
        notification.classList.add('show');

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        const cleanup = () => {
            overlay.classList.remove('show');
            notification.classList.remove('show');
            openBtn.onclick = null;
            copyBtn.onclick = null;
            cancelBtn.onclick = null;
        };

        openBtn.onclick = () => {
            cleanup();
            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ—Ç–∫—Ä—ã—Ç–∏—è
            try {
                // –°–ø–æ—Å–æ–± 1: –û–±—ã—á–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                const newWindow = window.open(url, '_blank');

                // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å (–±—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª popup)
                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                    // –°–ø–æ—Å–æ–± 2: –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ location (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤)
                    if (isLocalFile) {
                        showNotification('–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–∞. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
                    } else {
                        // –°–ø–æ—Å–æ–± 3: –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –∏ –∫–ª–∏–∫–∞–µ–º –ø–æ –Ω–µ–π
                        const tempLink = document.createElement('a');
                        tempLink.href = url;
                        tempLink.target = '_blank';
                        tempLink.rel = 'noopener noreferrer';
                        document.body.appendChild(tempLink);
                        tempLink.click();
                        document.body.removeChild(tempLink);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Å—ã–ª–∫–∏:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ—ë –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
            }
        };

        copyBtn.onclick = () => {
            navigator.clipboard.writeText(url).then(() => {
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                cleanup();
            }).catch(() => {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                cleanup();
            });
        };

        cancelBtn.onclick = cleanup;
        overlay.onclick = cleanup;
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–æ—Å–∫–∏
    function renderBoard() {
        boardElement.innerHTML = '';

        boardData.columns.forEach(column => {
            const columnElement = document.createElement('div');
            columnElement.className = column.collapsed ? 'column collapsed' : 'column';
            columnElement.dataset.columnId = column.id;

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–ª–æ–Ω–∫–∏
            const columnHeader = document.createElement('div');
            columnHeader.className = 'column-header';

            const titleSpan = document.createElement('span');
            titleSpan.className = 'column-title';
            titleSpan.textContent = column.title;

            columnHeader.appendChild(titleSpan);

            // –°—á–µ—Ç—á–∏–∫ –∫–∞—Ä—Ç–æ—á–µ–∫
            const cardsCounter = document.createElement('div');
            cardsCounter.className = 'cards-counter';
            cardsCounter.textContent = column.cards.length;

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
            if (column.cards.length === 0) {
                cardsCounter.classList.add('cards-zero');
            } else if (column.cards.length <= 5) {
                cardsCounter.classList.add('cards-few');
            } else if (column.cards.length <= 10) {
                cardsCounter.classList.add('cards-medium');
            } else {
                cardsCounter.classList.add('cards-many');
            }

            columnHeader.appendChild(cardsCounter);

            // –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
            const collapseBtn = document.createElement('button');
            collapseBtn.className = 'collapse-btn';
            collapseBtn.innerHTML = column.collapsed ? '+' : '‚àí';
            collapseBtn.title = column.collapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–æ–ª–æ–Ω–∫—É' : '–°–≤–µ—Ä–Ω—É—Ç—å –∫–æ–ª–æ–Ω–∫—É';
            collapseBtn.onclick = () => toggleColumnCollapse(column.id);
            columnHeader.appendChild(collapseBtn);

            columnElement.appendChild(columnHeader);

            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –Ω–µ —Å–≤–µ—Ä–Ω—É—Ç–∞)
            if (!column.collapsed) {
                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'cards-container';
                columnElement.appendChild(cardsContainer);

                // –ö–∞—Ä—Ç–æ—á–∫–∏
                column.cards.forEach(card => {
                    const cardElement = createCardElement(card, column.id);
                    cardsContainer.appendChild(cardElement);
                });

                // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
                const addButton = document.createElement('button');
                addButton.className = 'add-card-btn';
                addButton.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å';
                addButton.onclick = () => showCardForm(column.id, cardsContainer, addButton);
                columnElement.appendChild(addButton);
            }

            boardElement.appendChild(columnElement);
        });

        makeCardsDraggable();
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–≤–µ—Ä–Ω—É—Ç–æ—Å—Ç–∏ –∫–æ–ª–æ–Ω–∫–∏
    function toggleColumnCollapse(columnId) {
        const column = boardData.columns.find(col => col.id === columnId);
        if (column) {
            column.collapsed = !column.collapsed;
            saveBoard(false);
            renderBoard();
        }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
    function createCardElement(card, columnId) {
        const cardElement = document.createElement('div');
        cardElement.className = `card urgency-${card.urgency || 'medium'}`;

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–∞—à–∏–Ω—ã
        if (card.machine === 'KBA') {
            cardElement.classList.add('machine-kba');
        } else if (card.machine === 'ROLAND') {
            cardElement.classList.add('machine-roland');
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –¥–µ–¥–ª–∞–π–Ω–æ–≤
        if (card.deadlineStatus === 'overdue') {
            cardElement.classList.add('overdue');
        } else if (card.deadlineStatus === 'due-soon' || card.deadlineStatus === 'due-today') {
            cardElement.classList.add('due-soon');
        }

        cardElement.dataset.cardId = card.id;
        cardElement.draggable = true;

        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
        const priorityStrip = document.createElement('div');
        priorityStrip.className = `priority-strip priority-${card.priority || 'medium'}`;

        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–∞—Ä—Ç–æ—á–∫–∏ (–±–µ–∑ –ø–æ–ª–æ—Å–∫–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
        const cardContent = document.createElement('div');
        cardContent.className = 'card-content';
        cardContent.style.flex = '1';

        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ (–∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞)
        const topContainer = document.createElement('div');
        topContainer.style.display = 'flex';
        topContainer.style.justifyContent = 'space-between';
        topContainer.style.alignItems = 'flex-start';
        topContainer.style.marginBottom = '4px';

        const titleDiv = document.createElement('div');
        titleDiv.className = 'card-title';
        titleDiv.textContent = card.title;
        titleDiv.style.flex = '1';
        titleDiv.style.marginRight = '8px';

        const idContainer = document.createElement('div');
        idContainer.style.display = 'flex';
        idContainer.style.alignItems = 'center';
        idContainer.style.gap = '4px';

        const idDiv = document.createElement('div');
        idDiv.className = 'card-id';
        idDiv.textContent = `#${card.orderId || '00000'}`;
        idDiv.style.fontWeight = 'bold';
        idDiv.style.fontSize = 'calc(0.95em * var(--zoom-level))';
        idDiv.style.color = '#0052cc';
        idDiv.style.whiteSpace = 'nowrap';

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Å—Å—ã–ª–∫–∏
        const linkIcon = document.createElement('span');
        linkIcon.className = card.pdfLink ? 'card-link' : 'card-link disabled';
        linkIcon.innerHTML = 'üîó';
        linkIcon.title = card.pdfLink ? '–û—Ç–∫—Ä—ã—Ç—å PDF —Ñ–∞–π–ª' : '–°—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';

        if (card.pdfLink) {
            linkIcon.onclick = (e) => {
                e.stopPropagation();
                openPdfLink(card.pdfLink, card.title);
            };
        }

        idContainer.appendChild(idDiv);
        idContainer.appendChild(linkIcon);

        topContainer.appendChild(titleDiv);
        topContainer.appendChild(idContainer);

        const sheetsDiv = document.createElement('div');
        sheetsDiv.className = 'card-info';
        sheetsDiv.textContent = `–õ–∏—Å—Ç–æ–≤: ${card.sheets || '0'}`;

        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–¥–µ–ª–∏—è –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
        const productMaterialRow = document.createElement('div');
        productMaterialRow.className = 'product-material-row';

        const productTypeDiv = document.createElement('div');
        productTypeDiv.className = 'card-info';
        productTypeDiv.textContent = `–ò–∑–¥–µ–ª–∏–µ: ${card.productType || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}`;

        const materialDiv = document.createElement('div');
        materialDiv.className = 'card-info';
        materialDiv.textContent = `–ú–∞—Ç–µ—Ä–∏–∞–ª: ${card.material || '–ù–µ —É–∫–∞–∑–∞–Ω'}`;

        productMaterialRow.appendChild(productTypeDiv);
        productMaterialRow.appendChild(materialDiv);

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—à–∏–Ω–µ
        const machineDiv = document.createElement('div');
        machineDiv.className = 'card-info';
        machineDiv.textContent = `–ú–∞—à–∏–Ω–∞: ${card.machine ? card.machine : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}`;

        const startDateDiv = document.createElement('div');
        startDateDiv.className = 'card-info';
        startDateDiv.textContent = `–ó–∞–ø—É—Å–∫: ${formatDate(card.startDate) || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}`;

        const deadlineDiv = document.createElement('div');
        deadlineDiv.className = 'deadline-info';

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –¥–µ–¥–ª–∞–π–Ω–∞
        if (card.deadlineStatus === 'overdue') {
            deadlineDiv.classList.add('deadline-overdue');
            deadlineDiv.innerHTML = `‚è∞ –ü–†–û–°–†–û–ß–ï–ù–û: ${formatDate(card.deadline) || '–ù–µ —É–∫–∞–∑–∞–Ω'}`;
        } else if (card.deadlineStatus === 'due-today') {
            deadlineDiv.classList.add('deadline-soon');
            deadlineDiv.innerHTML = `‚ö†Ô∏è –°–ï–ì–û–î–ù–Ø: ${formatDate(card.deadline) || '–ù–µ —É–∫–∞–∑–∞–Ω'}`;
        } else if (card.deadlineStatus === 'due-soon') {
            deadlineDiv.classList.add('deadline-soon');
            deadlineDiv.innerHTML = `‚ö†Ô∏è –°–ö–û–†–û: ${formatDate(card.deadline) || '–ù–µ —É–∫–∞–∑–∞–Ω'}`;
        } else {
            deadlineDiv.innerHTML = `üìÖ –î–µ–¥–ª–∞–π–Ω: ${formatDate(card.deadline) || '–ù–µ —É–∫–∞–∑–∞–Ω'}`;
        }

        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'card-tags';

        if (card.tags && card.tags.length > 0) {
            card.tags.forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.className = `card-tag tag-${tag}`;
                tagSpan.textContent = getTagName(tag);
                tagsDiv.appendChild(tagSpan);
            });
        }

        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –∫–∞—Ä—Ç–æ—á–∫–æ–π
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'card-actions';

        const alertBtn = document.createElement('button');
        alertBtn.className = 'card-action-btn alert-card';
        alertBtn.innerHTML = '‚ö†Ô∏è';
        alertBtn.title = '–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ';
        alertBtn.onclick = (e) => {
            e.stopPropagation();
            createAlert(card, columnId);
        };

        const editBtn = document.createElement('button');
        editBtn.className = 'card-action-btn edit-card';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
        editBtn.onclick = (e) => {
            e.stopPropagation();
            showEditCardForm(card, columnId, cardElement);
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'card-action-btn delete-card';
        deleteBtn.innerHTML = '‚ùå';
        deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteCard(card.id, columnId);
        };

        actionsDiv.appendChild(alertBtn);
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);

        // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
        cardContent.appendChild(topContainer);
        cardContent.appendChild(sheetsDiv);
        cardContent.appendChild(productMaterialRow);
        cardContent.appendChild(machineDiv);
        cardContent.appendChild(startDateDiv);
        cardContent.appendChild(deadlineDiv);
        if (card.tags && card.tags.length > 0) {
            cardContent.appendChild(tagsDiv);
        }
        cardContent.appendChild(actionsDiv);

        cardElement.appendChild(priorityStrip);
        cardElement.appendChild(cardContent);

        return cardElement;
    }

    // –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
    function showEditCardForm(card, columnId, cardElement) {
        // –ó–∞–º–µ–Ω—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ñ–æ—Ä–º–æ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const form = document.createElement('div');
        form.className = 'card-form';
        form.innerHTML = `
                <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞" id="edit-card-title" value="${escapeHtml(card.title || '')}" required>
                <input type="text" placeholder="–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞" id="edit-card-order-id" value="${escapeHtml(card.orderId || '')}">

                <div class="link-input-container">
                    <label for="edit-card-pdf-link">–°—Å—ã–ª–∫–∞ –Ω–∞ PDF —Ñ–∞–π–ª:</label>
                    <input type="text" placeholder="file:///C:/path/to/file.pdf –∏–ª–∏ https://example.com/file.pdf" id="edit-card-pdf-link"
                           class="link-input" value="${escapeHtml(card.pdfLink || '')}">
<!--                    <div class="link-help">-->
<!--                        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ (file:///C:/...), —Å–µ—Ç–µ–≤—ã–µ –ø—É—Ç–∏ (\\server\folder), –≤–µ–±-—Å—Å—ã–ª–∫–∏ (https://...)-->
<!--                    </div>-->
                </div>

                <input type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–æ–≤" id="edit-card-sheets" value="${card.sheets || ''}" min="0">

                <select id="edit-card-product-type">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –∏–∑–¥–µ–ª–∏—è</option>
                    ${productTypes.map(type => `
                        <option value="${type}" ${card.productType === type ? 'selected' : ''}>${type}</option>
                    `).join('')}
                </select>

                <select id="edit-card-material">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>
                    ${materialTypes.map(material => `
                        <option value="${material}" ${card.material === material ? 'selected' : ''}>${material}</option>
                    `).join('')}
                </select>

                <label for="edit-card-start-date">–î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞:</label>
                <input type="date" id="edit-card-start-date" value="${card.startDate || ''}">

                <label for="edit-card-deadline">–î–µ–¥–ª–∞–π–Ω:</label>
                <input type="date" id="edit-card-deadline" value="${card.deadline || ''}">

                <select id="edit-card-priority">
                    <option value="high" ${card.priority === 'high' ? 'selected' : ''}>–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    <option value="medium" ${card.priority === 'medium' || !card.priority ? 'selected' : ''}>–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    <option value="low" ${card.priority === 'low' ? 'selected' : ''}>–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                </select>

                <select id="edit-card-urgency">
                    <option value="high" ${card.urgency === 'high' ? 'selected' : ''}>–°—Ä–æ—á–Ω—ã–π</option>
                    <option value="medium" ${card.urgency === 'medium' || !card.urgency ? 'selected' : ''}>–û–±—ã—á–Ω—ã–π</option>
                    <option value="low" ${card.urgency === 'low' ? 'selected' : ''}>–ù–µ —Å—Ä–æ—á–Ω—ã–π</option>
                </select>

                <div class="tags-selector" id="edit-card-tags">
                    ${availableTags.map(tag => `
                        <div class="tag-option ${card.tags && card.tags.includes(tag.id) ? 'selected' : ''}"
                             data-tag="${tag.id}" onclick="toggleTag(this)">
                            ${tag.name}
                        </div>
                    `).join('')}
                </div>

                <select id="edit-card-machine">
                    <option value="none">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—á–∞—Ç–Ω—É—é –º–∞—à–∏–Ω—É</option>
                    <option value="KBA" ${card.machine === 'KBA' ? 'selected' : ''}>KBA</option>
                    <option value="ROLAND" ${card.machine === 'ROLAND' ? 'selected' : ''}>ROLAND</option>
                </select>

                <div class="card-form-actions">
                    <button id="save-edit-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button id="cancel-edit-btn">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            `;

        cardElement.replaceWith(form);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–≥–æ–≤
        window.toggleTag = function(element) {
            element.classList.toggle('selected');
        };

        document.getElementById('save-edit-btn').onclick = () => {
            const title = document.getElementById('edit-card-title').value;
            const orderId = document.getElementById('edit-card-order-id').value;
            const pdfLink = document.getElementById('edit-card-pdf-link').value;
            const sheets = document.getElementById('edit-card-sheets').value;
            const productType = document.getElementById('edit-card-product-type').value;
            const material = document.getElementById('edit-card-material').value;
            const startDate = document.getElementById('edit-card-start-date').value;
            const deadline = document.getElementById('edit-card-deadline').value;
            const priority = document.getElementById('edit-card-priority').value;
            const urgency = document.getElementById('edit-card-urgency').value;
            const machine = document.getElementById('edit-card-machine').value;

            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏
            const selectedTags = [];
            document.querySelectorAll('#edit-card-tags .tag-option.selected').forEach(option => {
                selectedTags.push(option.dataset.tag);
            });

            if (title) {
                const updatedCard = {
                    ...card,
                    title,
                    orderId,
                    pdfLink: pdfLink || null,
                    sheets: sheets ? parseInt(sheets) : 0,
                    productType,
                    material,
                    startDate,
                    deadline,
                    priority,
                    urgency,
                    machine,
                    tags: selectedTags
                };

                // –ù–∞—Ö–æ–¥–∏–º –∫–æ–ª–æ–Ω–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                const column = boardData.columns.find(col => col.id === columnId);
                if (column) {
                    const cardIndex = column.cards.findIndex(c => c.id === card.id);
                    if (cardIndex !== -1) {
                        column.cards[cardIndex] = updatedCard;

                        if (isConnected) {
                            sendMessage({
                                type: 'card_updated',
                                userId: currentUser.id,
                                columnId: columnId,
                                card: updatedCard
                            });
                        } else {
                            saveBoard(true);
                        }

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–¥–ª–∞–π–Ω –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        checkDeadlines();
                        renderBoard();
                    }
                }
            }
        };

        document.getElementById('cancel-edit-btn').onclick = () => {
            form.replaceWith(cardElement);
        };
    }

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
    function deleteCard(cardId, columnId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É?')) {
            const column = boardData.columns.find(col => col.id === columnId);
            if (column) {
                column.cards = column.cards.filter(card => card.id !== cardId);

                if (isConnected) {
                    sendMessage({
                        type: 'card_deleted',
                        userId: currentUser.id,
                        cardId: cardId,
                        columnId: columnId
                    });
                } else {
                    saveBoard(true);
                }

                renderBoard();
            }
        }
    }

    // –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
    function showCardForm(columnId, cardsContainer, addButton) {
        addButton.style.display = 'none';

        const form = document.createElement('div');
        form.className = 'card-form';

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –¥–µ–¥–ª–∞–π–Ω–∞ (—á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π)
        const defaultDeadline = new Date();
        defaultDeadline.setDate(defaultDeadline.getDate() + 7);
        const deadlineValue = defaultDeadline.toISOString().split('T')[0];

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞
        const startDateValue = new Date().toISOString().split('T')[0];

        form.innerHTML = `
                <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞" id="card-title" required>
                <input type="text" placeholder="–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞" id="card-order-id">

                <div class="link-input-container">
                    <label for="card-pdf-link">–°—Å—ã–ª–∫–∞ –Ω–∞ PDF —Ñ–∞–π–ª:</label>
                    <input type="text" placeholder="file:///C:/path/to/file.pdf –∏–ª–∏ https://example.com/file.pdf" id="card-pdf-link" class="link-input">
<!--                    <div class="link-help">-->
<!--                        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ (file:///C:/...), —Å–µ—Ç–µ–≤—ã–µ –ø—É—Ç–∏ (\\server\folder), –≤–µ–±-—Å—Å—ã–ª–∫–∏ (https://...)-->
<!--                    </div>-->
                </div>

                <input type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–æ–≤" id="card-sheets" min="0" value="0">

                <select id="card-product-type">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –∏–∑–¥–µ–ª–∏—è</option>
                    ${productTypes.map(type => `
                        <option value="${type}">${type}</option>
                    `).join('')}
                </select>

                <select id="card-material">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>
                    ${materialTypes.map(material => `
                        <option value="${material}">${material}</option>
                    `).join('')}
                </select>

                <label for="card-start-date">–î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞:</label>
                <input type="date" id="card-start-date" value="${startDateValue}">

                <label for="card-deadline">–î–µ–¥–ª–∞–π–Ω:</label>
                <input type="date" id="card-deadline" value="${deadlineValue}">

                <select id="card-priority">
                    <option value="high">–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    <option value="low">–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                </select>

                <select id="card-urgency">
                    <option value="high">–°—Ä–æ—á–Ω—ã–π</option>
                    <option value="medium" selected>–û–±—ã—á–Ω—ã–π</option>
                    <option value="low">–ù–µ —Å—Ä–æ—á–Ω—ã–π</option>
                </select>

                <div class="tags-selector" id="card-tags">
                    ${availableTags.map(tag => `
                        <div class="tag-option" data-tag="${tag.id}" onclick="toggleTag(this)">
                            ${tag.name}
                        </div>
                    `).join('')}
                </select>

                <select id="card-machine">
                    <option value="none">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—á–∞—Ç–Ω—É—é –º–∞—à–∏–Ω—É</option>
                    <option value="KBA">KBA</option>
                    <option value="ROLAND">ROLAND</option>
                </select>

                <div class="card-form-actions">
                    <button id="add-card-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button id="cancel-card-btn">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;

        cardsContainer.appendChild(form);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–≥–æ–≤
        window.toggleTag = function(element) {
            element.classList.toggle('selected');
        };

        document.getElementById('add-card-btn').onclick = () => {
            const title = document.getElementById('card-title').value;
            const orderId = document.getElementById('card-order-id').value;
            const pdfLink = document.getElementById('card-pdf-link').value;
            const sheets = document.getElementById('card-sheets').value;
            const productType = document.getElementById('card-product-type').value;
            const material = document.getElementById('card-material').value;
            const startDate = document.getElementById('card-start-date').value;
            const deadline = document.getElementById('card-deadline').value;
            const priority = document.getElementById('card-priority').value;
            const urgency = document.getElementById('card-urgency').value;
            const machine = document.getElementById('card-machine').value;

            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏
            const selectedTags = [];
            document.querySelectorAll('#card-tags .tag-option.selected').forEach(option => {
                selectedTags.push(option.dataset.tag);
            });

            if (title) {
                const newCard = {
                    id: Date.now(),
                    title,
                    orderId: orderId || `T-${Math.floor(23000 + Math.random() * 1000)}`,
                    pdfLink: pdfLink || null,
                    sheets: sheets ? parseInt(sheets) : 0,
                    productType,
                    material,
                    startDate,
                    deadline,
                    priority,
                    urgency,
                    machine,
                    tags: selectedTags
                };

                // –ù–∞—Ö–æ–¥–∏–º –∫–æ–ª–æ–Ω–∫—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                const column = boardData.columns.find(col => col.id === columnId);
                if (column) {
                    column.cards.push(newCard);

                    if (isConnected) {
                        sendMessage({
                            type: 'card_created',
                            userId: currentUser.id,
                            columnId: columnId,
                            card: newCard
                        });
                    } else {
                        saveBoard(true);
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–¥–ª–∞–π–Ω –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                    checkDeadlines();
                    renderBoard();
                }
            }
        };

        document.getElementById('cancel-card-btn').onclick = () => {
            cardsContainer.removeChild(form);
            addButton.style.display = 'block';
        };
    }

    // –î–µ–ª–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º–∏
    function makeCardsDraggable() {
        const cards = document.querySelectorAll('.card');
        const columns = document.querySelectorAll('.column');
        const cardsContainers = document.querySelectorAll('.cards-container');

        cards.forEach(card => {
            card.addEventListener('dragstart', dragStart);
            card.addEventListener('dragend', dragEnd);
        });

        columns.forEach(column => {
            column.addEventListener('dragover', dragOver);
            column.addEventListener('dragenter', dragEnter);
            column.addEventListener('dragleave', dragLeave);
            column.addEventListener('drop', dragDrop);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫ (–¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏)
        cardsContainers.forEach(container => {
            container.addEventListener('dragover', dragOverContainer);
            container.addEventListener('drop', dropInContainer);
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    function dragStart() {
        draggedCard = this;
        sourceColumnId = parseInt(this.parentElement.parentElement.dataset.columnId);
        setTimeout(() => {
            this.style.opacity = '0.5';
            this.classList.add('dragging');
        }, 0);
    }

    function dragEnd() {
        this.style.opacity = '1';
        this.classList.remove('dragging');
        draggedCard = null;
        sourceColumnId = null;

        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã drag-over —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.querySelectorAll('.drag-over').forEach(el => {
            el.classList.remove('drag-over');
        });
    }

    function dragOver(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    }

    function dragEnter(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    }

    function dragLeave() {
        this.classList.remove('drag-over');
    }

    function dragOverContainer(e) {
        e.preventDefault();
        this.classList.add('drag-over');

        const afterElement = getDragAfterElement(this, e.clientY);
        const draggable = document.querySelector('.dragging');

        if (draggable) {
            if (afterElement == null) {
                this.appendChild(draggable);
            } else {
                this.insertBefore(draggable, afterElement);
            }
        }
    }

    function dropInContainer(e) {
        e.preventDefault();
        this.classList.remove('drag-over');

        const container = this;
        const columnId = parseInt(container.parentElement.dataset.columnId);
        const cardId = parseInt(draggedCard.dataset.cardId);

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –¥–∞–Ω–Ω—ã—Ö
        updateCardsOrder(container, columnId, cardId);
    }

    function dragDrop() {
        this.style.backgroundColor = 'var(--color-column)';
        this.classList.remove('drag-over');

        if (draggedCard) {
            const targetColumnId = parseInt(this.dataset.columnId);
            const cardId = parseInt(draggedCard.dataset.cardId);

            // –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
            if (sourceColumnId !== targetColumnId) {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ
                applyCardMove(cardId, sourceColumnId, targetColumnId);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
                if (isConnected) {
                    sendMessage({
                        type: 'card_moved',
                        userId: currentUser.id,
                        cardId: cardId,
                        fromColumnId: sourceColumnId,
                        toColumnId: targetColumnId
                    });
                } else {
                    saveBoard(false);
                }
            } else {
                // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ —Ç–æ–π –∂–µ –∫–æ–ª–æ–Ω–∫–∏
                const container = this.querySelector('.cards-container');
                if (container) {
                    updateCardsOrder(container, targetColumnId, cardId);
                }
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ –∫–∞–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    function updateCardsOrder(container, columnId, movedCardId) {
        const column = boardData.columns.find(col => col.id === columnId);
        if (!column) return;

        // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑ DOM
        const newOrder = [];
        const cardElements = container.querySelectorAll('.card');
        cardElements.forEach(cardElement => {
            const cardId = parseInt(cardElement.dataset.cardId);
            const card = column.cards.find(c => c.id === cardId);
            if (card) {
                newOrder.push(card);
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        column.cards = newOrder;

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º, –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
        if (isConnected) {
            sendMessage({
                type: 'card_reordered',
                userId: currentUser.id,
                columnId: columnId,
                cards: newOrder
            });
        } else {
            saveBoard(false);
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function getTagName(tag) {
        const tagNames = {
            'design': '–§–æ—Ä–º—ã',
            'print': '–ë—É–º–∞–≥–∞',
            'cut': '–ü–æ–¥—Ä–µ–∑',
            'bind': '–ì–æ—Ñ—Ä–∞',
            'done': '–ü–ª–µ–Ω–∫–∞',
            'one': '1–ø—Ä–æ–≥',
            'two': '2–ø—Ä–æ–≥'
        };
        return tagNames[tag] || tag;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return new Date(dateString).toLocaleDateString('ru-RU', options);
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å–∫–∏ –≤ localStorage
    function saveBoard(showNotification) {
        localStorage.setItem('typographyKanban', JSON.stringify(boardData));

        if (showNotification) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
            saveNotification.textContent = '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
            saveNotification.classList.add('show');
            setTimeout(() => {
                saveNotification.classList.remove('show');
            }, 2000);
        }
    }

    // –°–±—Ä–æ—Å –¥–æ—Å–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ
    function resetBoard() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –¥–æ—Å–∫—É? –í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
            localStorage.removeItem('typographyKanban');
            window.location.reload();
        }
    }

    // –°–±—Ä–æ—Å –¥–æ—Å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    function resetServerBoard() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –¥–æ—Å–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.')) {
            if (isConnected) {
                sendMessage({
                    type: 'reset_board'
                });
                showNotification('–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            } else {
                alert('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É. –°–±—Ä–æ—Å –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.');
            }
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    // saveButton.addEventListener('click', () => saveBoard(true));
    // resetButton.addEventListener('click', resetBoard);
    // resetServerButton.addEventListener('click', resetServerBoard);
    connectButton.addEventListener('click', connectToServer);
    zoomInButton.addEventListener('click', zoomIn);
    zoomOutButton.addEventListener('click', zoomOut);
    zoomResetButton.addEventListener('click', resetZoom);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –ø–æ –∫–ª–∏–∫—É
    alertBanner.addEventListener('click', clearAlert);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', initBoard);
</script>
</body>
</html>